/*
 * Copyright 2010-2014 icl-network.com. All rights reserved.
 * Support: http://www.icl-network.com
 *
 * JavaScript - Repay
 * Version: 3.0
 */
$().ready(function() {
	
		var $repaymentConfirmForm = $("#repaymentConfirmForm"), $repaymentPlan = $repaymentConfirmForm.find("[name='repaymentPlan']"), $password = $repaymentConfirmForm.find("[name='password']"), $repaymentConfirmFromSubmit = $repaymentConfirmForm.find(":submit"), rsaKey = new RSAKey();
	$repaymentConfirmFromSubmit.prop("disabled", false);
	rsaKey.setPublic(b64tohex(modulus), b64tohex(exponent));
	$repaymentConfirmForm.validate({
		rules: {
			password: {
				required: true,
				pattern: /^[^\s&\"<>]+$/,
				minlength: 4,
				maxlength: 20
			},
			agreement : "required"
		},
		messages: {
			password: {
				required: "请输入支付密码",
				pattern: "密码包含非法字符",
				minlength: "请输入4-20位密码",
				maxlength: "请输入4-20位密码"
			},
			agreement: "请先阅读《借款协议》并确认同意"
		},
		errorPlacement: function(error, element) {
			element.closest("td").find(".annotate").text(error.text());
		},
		unhighlight: function(element) {
			$(element).closest("td").find(".annotate").text("");
		},
		submitHandler: function(form) {
			$repaymentConfirmFromSubmit.prop("disabled", true);
			$password.val(hex2b64(rsaKey.encrypt($password.val())));
			form.submit();
		}
	});

	var $repaymentPeriods = $repaymentConfirmForm.find(".repaymentPeriod");
	var $repaymentCapitalInterests = $repaymentConfirmForm.find(".repaymentCapitalInterest");
	var $repaymentOverduePeriods = $repaymentConfirmForm.find(".repaymentOverduePeriod");
	var $repaymentOverdueInterests = $repaymentConfirmForm.find(".repaymentOverdueInterest");
	var $repaymentFees = $repaymentConfirmForm.find(".repaymentFee");
	var $repaymentCountAmounts = $repaymentConfirmForm.find(".repaymentCountAmount");
	var $repaymentPlanDates = $repaymentConfirmForm.find(".repaymentPlanDate");
	
	$(".repay").click(function(e) {
		e.preventDefault();
		
		var $this = $(this);
		var $repaymentTr = $this.closest("tr");
		$repaymentPlan.val($this.attr("repaymentPlan"));
		$password.val("");
		$repaymentPeriods.text($repaymentTr.find(".repaymentPeriod").text());
		$repaymentCapitalInterests.text($repaymentTr.find(".repaymentCapitalInterest").text());
		$repaymentOverduePeriods.text($repaymentTr.find(".repaymentOverduePeriod").text());
		$repaymentOverdueInterests.text($repaymentTr.find(".repaymentOverdueInterest").text());
		$repaymentFees.text($repaymentTr.find(".repaymentFee").text());
		$repaymentCountAmounts.text($repaymentTr.find(".repaymentCountAmount").text());
		$repaymentPlanDates.text($repaymentTr.find(".repaymentPlanDate").text());
	
		$.colorbox({
			href: "#repaymentConfirmForm", 
			inline: true, 
			overlayClose: false
		});
		
	});
	
	$repaymentConfirmForm.find(".cancel").click(function() {
		$repaymentConfirmForm.colorbox.close();
	});
	
});
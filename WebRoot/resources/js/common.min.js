/*
 * Copyright 2010-2013 icl-network.com. All rights reserved.
 * Support: http://www.icl-network.com
 * 
 * JavaScript - Common
 * Version: 3.0
 */

var setting = {
	base: "/P2P-2.0-YuXinChuangTou",
	locale: "zh_CN",
	currencyScale: "",
	currencyRoundType: "",
	currencySign: "",
	currencyUnit: "",
	uploadImageExtension: "jpg,jpeg,bmp,gif,png",
	uploadFlashExtension: "swf,flv",
	uploadMediaExtension: "swf,flv,mp3,wav,avi,rm,rmvb",
	uploadFileExtension: "zip,rar,7z,doc,docx,xls,xlsx,ppt,pptx"
};

function currency(value, showSign, showUnit) {
	if (value != null) {
		var currency;
		if (setting.currencyRoundType == "roundHalfUp") {
			currency = (Math.round(value * Math.pow(10, setting.currencyScale)) / Math.pow(10, setting.currencyScale)).toFixed(setting.currencyScale);
		} else if (setting.currencyRoundType == "roundUp") {
			currency = (Math.ceil(value * Math.pow(10, setting.currencyScale)) / Math.pow(10, setting.currencyScale)).toFixed(setting.currencyScale);
		} else {
			currency = (Math.floor(value * Math.pow(10, setting.currencyScale)) / Math.pow(10, setting.currencyScale)).toFixed(setting.currencyScale);
		}
		if (showSign) {
			currency = setting.currencySign + currency;
		}
		if (showUnit) {
			currency += setting.currencyUnit;
		}
		return currency;
	}
}

$().ready(function() {

	var $headerUsername = $("#headerUsername");
	var $headerUsernameText = $("#headerUsernameText");
	var $headerLogout = $("#headerLogout");
	var $headerRegister = $("#headerRegister");
	var $headerLogin = $("#headerLogin");
	var username = $.cookie("P2PUsername");
	if (username != null) {
		$headerUsernameText.text(username).show();
		$headerUsername.show();
		$headerLogout.show();
		$headerRegister.hide();
		$headerLogin.hide();
	}

	$.checkLogin = function() {
		var result = false;
		$.ajax({
			url: "/P2P-2.0-YuXinChuangTou/login/check",
			type: "get",
			dataType: "json",
			cache: false,
			async: false,
			success: function(data) {
				result = data;
			}
		});
		return result;
	}

	var $document = $(document);
	
	$document.ajaxSend(function(event, request, settings) {
		if (!settings.crossDomain && settings.type != null && settings.type.toLowerCase() != "get") {
			var token = $.cookie("token");
			if (token != null) {
				request.setRequestHeader("token", token);
			}
		}
	});
	
	$document.ajaxComplete(function(event, request, settings) {
		var loginStatus = request.getResponseHeader("loginStatus");
		var tokenStatus = request.getResponseHeader("tokenStatus");
		
		if (loginStatus == "accessDenied") {
			$.redirectLogin(location.href, "登录超时，请重新登录");
		} else if (tokenStatus == "accessDenied") {
			var token = getCookie("token");
			if (token != null) {
				$.extend(settings, {global: false, headers: {token: token}});
				$.ajax(settings);
			}
		}
		
	});
	
	$("form").submit(function() {
		var $this = $(this);
		var method = $this.prop("method");
		if (method != null && method.toLowerCase() != "get" && $this.find("input[name=token]").size() == 0) {
			var token = $.cookie("token");
			if (token != null) {
				$this.append("<input type=\"hidden\" name=\"token\" value=\"" + token + "\" \/>");
			}
		}
	});

});